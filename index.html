<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Survey randomization</title>
  <meta name="description" content="redirects and forwards user to random website from parameters">
  
	<script>
		var urlParams = new URLSearchParams(document.location.search)
		var links = urlParams.getAll('l')

		function getRandomInt(min, max) {
		
			var randomNumber = 0;
			if(Uint32Array && window.crypto && window.crypto.getRandomValues){
				const randomBuffer = new Uint32Array(1);
				window.crypto.getRandomValues(randomBuffer);
				randomNumber = randomBuffer[0] / (0xffffffff + 1);
			}else{
				randomNumber = Math.random();
			}
		
			min = Math.ceil(min);
			max = Math.floor(max);
			return Math.floor(randomNumber * (max - min + 1)) + min;
		}

		if(links.length != 0){
			console.log(links)
			var rand = getRandomInt(0, links.length - 1)
			var forward_url = links[rand];
			document.location.href = forward_url;
		}


		function generateURL(){
			var input_links = document.getElementsByTagName('input')
			
			var link = [];
			for(var x=0;x<input_links.length;x++){
				if(input_links[x].value != ""){
					link.push('l='+encodeURIComponent(input_links[x].value));
				}
			}


			var url = document.location.protocol + '//' + document.location.host + document.location.pathname + '?' + link.join('&');
			if(url.length >= 2048){
				url = 'URL is to long (over the 2048 character limit) use url shortener to make it shorter';
			}
			document.getElementById("link").innerHTML = url;
			
		}
	</script>

</head>

<body>
	<div id="forwarding">
		Redirecting to survey...
	</div>

	<div id="form" style="display:none;">
		<h1>Tool to manage random url redirecting</h1>
		<p>Enter the urls you want to redirect to. Press Generate Link. That link can then be distributed and it will randomly send visitors to one of the websites assigned.</p>
		<p>URL 1:<input type="text" name="l2"></p>
		<p>URL 2:<input type="text" name="l2"></p>
		<p>URL 3:<input type="text" name="l2"></p>
		<p>URL 4:<input type="text" name="l2"></p>
		<p>URL 5:<input type="text" name="l2"></p>
		<p>URL 6:<input type="text" name="l2"></p>
		<p>URL 7:<input type="text" name="l2"></p>
		<p>URL 8:<input type="text" name="l2"></p>
		<button onclick="generateURL()">Generate Link</button>
		<p id="link"></p>
		<div>
			<h4>Use this if you want to calculate how many participants you will need to get a certain likelihood of having a minimum number of participants visit each link.</h4>
			<p>Number of links: <input type="text" id="nr_of_links" value="4"></p>
			<p>Minimum nr of participants per link: <input type="text" id="min_desired_nr_of_participants_per_link" value="8"></p>
			<button onclick="load_render_chart()">Show statistics</button>
		</div>
	</div>
	<div id="chart"></div>
	
<script>

if(links.length == 0){//Show form 
	document.getElementById("form").style = "";
	document.getElementById("forwarding").style.display = "none";
}else{
	document.getElementById("forwarding").innerHTML = "Redirecting to: <a id=\"url\" href=\"url\">url</a>";
	document.getElementById("url").href = forward_url;
	document.getElementById("url").textContent = forward_url;
}


function addCss(fileName) {

  var head = document.head;
  var link = document.createElement("link");

  link.type = "text/css";
  link.rel = "stylesheet";
  link.href = fileName;

  head.appendChild(link);
}
function injectScript(src) {
	return new Promise((resolve, reject) => {
		const script = document.createElement('script');
		script.src = src;
		script.addEventListener('load', resolve);
		script.addEventListener('error', e => reject(e.error));
		document.head.appendChild(script);
	});
}



function load_render_chart(){
	
	if(typeof(c3) == 'undefined'){
		addCss('https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.css');
		injectScript('https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js')
			.then(() => {
			injectScript('https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js')
				.then(() => {
				render_chart();
			})
		});
	}else{
		render_chart();
	}
}

function render_chart(){
	var under_val = parseInt(document.getElementById("min_desired_nr_of_participants_per_link").value);
	var nr_groups = parseInt(document.getElementById("nr_of_links").value);
	var participants = under_val*nr_groups;
		
	var how_long_to_analyze = participants*2;
	
	var smothing = 10;
	
	parts = ['participants'];
	dt = ['likelihood of getting under '+under_val+' partifipants in a group'];

	
	for(i=participants;i<participants+how_long_to_analyze;i++){
		var hits_under_val = 0;
		for(y=0;y<100*smothing;y++){
			arr=[];
			for(h=0;h<nr_groups;h++){
				arr.push(0);
			}
			for(x=0;x<i;x++){
				rnd = getRandomInt(0, arr.length-1);
				arr[getRandomInt(0, arr.length-1)]++
			}
			var min_val = Math.min.apply(Math, arr)
			if(under_val > min_val){
				hits_under_val++;
			}
		}
		parts.push(i);
		dt.push(hits_under_val/smothing);
	}

	var chart = c3.generate({
		data: {
			x: 'participants',
			columns: [
				parts,
				dt
			]
		},
		axis:{
			y:{
				label: 'liklyhod %'
			},
			x:{
				label: 'nr of participants'
			}
		}
	});
}

</script>
</body>
</html>
